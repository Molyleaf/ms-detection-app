{% extends "base.html" %}

{% block title %}MS2 Analysis Report{% endblock %}

{% block head_extra %}
<style>
  .smiles-row {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    flex-wrap: wrap;
  }
  .smiles-canvas {
    background: white;
    border: 1px solid var(--sl-color-neutral-200);
    border-radius: 6px;
  }
</style>

<!-- 轻量纯前端 SMILES 渲染：SmilesDrawer -->
<script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
<script>
  function renderSmilesDrawings() {
    if (!window.SmilesDrawer) return;

    const drawer = new SmilesDrawer.Drawer({
      width: 360,
      height: 220,
      padding: 12,
      compactDrawing: true
    });

    document.querySelectorAll('[data-smiles]')
      .forEach((el) => {
        const smiles = el.getAttribute('data-smiles') || '';
        const canvasId = el.getAttribute('data-canvas-id');
        if (!smiles || !canvasId) return;

        SmilesDrawer.parse(smiles, function(tree) {
          drawer.draw(tree, canvasId, 'light', false);
        }, function() {
          // 解析失败：保持显示原始 SMILES 文本
        });
      });
  }

  document.addEventListener('DOMContentLoaded', renderSmilesDrawings);
</script>
{% endblock %}

{% block content %}
<sl-breadcrumb style="margin-bottom: 1.5rem;">
  <sl-breadcrumb-item href="{{ url_for('index') }}">Home</sl-breadcrumb-item>
  <sl-breadcrumb-item href="javascript:history.back()">MS1 Results</sl-breadcrumb-item>
  <sl-breadcrumb-item>MS2 Report</sl-breadcrumb-item>
</sl-breadcrumb>

<div style="max-width: 800px; margin: 0 auto;">

  <div style="margin-bottom: 2rem;">
    <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
      Deep Analysis Report
      <sl-tag size="small">Parent m/z: {{ parent_mz }}</sl-tag>
    </h2>
  </div>

  <sl-card class="result-card" style="margin-bottom: 2rem; border-top: 4px solid; {% if risk_class == 'danger' %}var(--sl-color-danger-500){% else %}var(--sl-color-success-500){% endif %};">
    <div style="display: flex; flex-direction: column; gap: 1.5rem; text-align: center; padding: 1rem;">

      <div>
        {% if risk_class == 'danger' %}
        <sl-icon name="exclamation-triangle" style="font-size: 4rem; color: var(--sl-color-danger-500); margin-bottom: 1rem;"></sl-icon>
        <h1 style="margin: 0; color: var(--sl-color-danger-600);">High Risk Detected</h1>
        {% else %}
        <sl-icon name="check-circle" style="font-size: 4rem; color: var(--sl-color-success-500); margin-bottom: 1rem;"></sl-icon>
        <h1 style="margin: 0; color: var(--sl-color-success-600);">Safe / No Risk Found</h1>
        {% endif %}
      </div>

      <div style="max-width: 400px; margin: 0 auto; width: 100%;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600;">
          <span>Confidence Probability</span>
          <span>{{ prob }}%</span>
        </div>
        <sl-progress-bar value="{{ prob }}"
                         variant="{% if risk_class == 'danger' %}danger{% else %}success{% endif %}"
                         style="height: 10px;">
        </sl-progress-bar>
      </div>

    </div>
  </sl-card>

  {% if matches %}
  <h3 style="margin-bottom: 1rem; color: var(--sl-color-neutral-700);">
    <sl-icon name="database" style="margin-right: 0.5rem;"></sl-icon>
    Library Traceback Results
  </h3>

  <div style="display: flex; flex-direction: column; gap: 0.75rem;">
    {% for match in matches %}
    <sl-details>
      <div slot="summary" style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding-right: 1rem;">
        <span style="font-family: var(--sl-font-mono); font-weight: 600;">Match #{{ loop.index }}</span>
      </div>

      <div style="padding: 1rem; background: var(--sl-color-neutral-50); border-radius: 4px; margin-top: 0.5rem;">
        <strong style="color: var(--sl-color-neutral-600); font-size: 0.85rem;">SMILES Structure:</strong>
        <div class="smiles-row" style="margin-top: 0.75rem;">
          <canvas id="smiles-canvas-{{ loop.index }}" class="smiles-canvas" width="360" height="220"></canvas>
          <div style="min-width: 240px; flex: 1;">
            <div style="font-size: 0.75rem; color: var(--sl-color-neutral-500); margin-bottom: 0.25rem;">Raw SMILES</div>
            <div data-smiles="{{ match.smiles }}" data-canvas-id="smiles-canvas-{{ loop.index }}"
                 style="font-family: var(--sl-font-mono); word-break: break-all; color: var(--sl-color-neutral-800);">
              {{ match.smiles }}
            </div>
          </div>
        </div>
      </div>
    </sl-details>
    {% endfor %}
  </div>
  {% endif %}

  <div style="margin-top: 3rem; text-align: center;">
    <sl-button href="{{ url_for('index') }}" variant="neutral" outline>Return to Home</sl-button>
  </div>

</div>
{% endblock %}