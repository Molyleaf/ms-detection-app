<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>一级质谱分析结果</title>
  <style>
    .risk-Risk0, .risk-Risk1 { color: #d9534f; font-weight: bold; }
    .risk-Risk2 { color: #f0ad4e; font-weight: bold; }
    .risk-Safe { color: #5cb85c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    .action-cell { min-width: 300px; }
  </style>
</head>
<body>
<h1>一级质谱筛选结果 (模式: {{ mode }})</h1>
<p>系统已根据 <code>qlc.ipynb</code> 逻辑自动清理同位素峰并归一化强度。</p>

<table>
  <thead>
  <tr>
    <th>质量 (Mass)</th>
    <th>归一化强度</th>
    <th>风险等级</th>
    <th>库匹配质量</th>
    <th class="action-cell">二级质谱 (MS2) 分析</th>
  </tr>
  </thead>
  <tbody>
  {% for peak in peaks %}
  <tr>
    <td>{{ "%.4f"|format(peak.Mass) }}</td>
    <td>{{ "%.2f"|format(peak.Intensity) }}</td>
    <td class="risk-{{ peak.Risk_Level }}">
      {{ "安全" if peak.Risk_Level == 'Safe' else peak.Risk_Level }}
    </td>
    <td>{{ "%.4f"|format(peak.Matched_Mass) if peak.Matched_Mass > 0 else "-" }}</td>
    <td>
      <form action="/analyze_ms2" method="post" enctype="multipart/form-data" style="display: flex; gap: 5px;">
        <input type="hidden" name="parent_mz" value="{{ peak.Mass }}">
        <input type="hidden" name="risk_level" value="{{ peak.Risk_Level }}">
        <input type="hidden" name="matched_mass" value="{{ peak.Matched_Mass }}">

        {% if peak.Risk_Level in ['Risk1', 'Risk2'] %}
        <input type="file" name="ms2_file" accept=".xlsx, .xls, .csv" required style="width: 180px;">
        <button type="submit" style="background: #d9534f; color: white; border: none; padding: 5px 10px; cursor: pointer;">解析文件并判定</button>
        {% else %}
        <input type="text" name="ms2_data" placeholder="格式 mz:int,mz:int">
        <button type="submit">分析</button>
        {% endif %}
      </form>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
<br>
<a href="/">返回重新上传 MS1</a>
</body>
</html>